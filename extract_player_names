#!/bin/bash

# Change the directory to the log folder
cd /home/mcserver/minecraft/logs

# Initialize an associative array to store player names and their occurrence counts
declare -A player_counts
declare -A player_dates

# Loop through each .gz file in the directory
for file in *.gz; do
    # Use zgrep to search for player names and count their occurrences
    # The regular expression ' joined the game' will match lines with player names followed by ' joined the game'
    # The -o option for grep only prints the matching part of the line.
    # The -h option for zgrep suppresses filenames in the output.
    names_found=$(zgrep -oE '[[:alnum:]_]+ joined the game' "$file" | awk '{print $1}')

    # Increment the occurrence count for each player name
    for name in $names_found; do
        player_counts["$name"]=$(( player_counts["$name"] + 1 ))
    done

    for name in $names_found; do
        player_dates["$name"]=$(date -r "$file" +%Y-%m-%d)
    done
done

# Format the player names, counts, and most recent join times into a table
formatted_names=()
for name in "${!player_counts[@]}"; do
    count="${player_counts[$name]}"
    last_join_timestamp="${player_dates[$name]}"
    formatted_names+=("$name|$count|$last_join_date")
done

# Print the table header
echo "Player Name|Count|Most Recent Join Time"

# Print the formatted player names, counts, and most recent join times in a table
echo "${formatted_names[@]}" | tr ' ' '\n' | column -t -s '|'

# Join the formatted player names with spaces
search_strings=$(IFS=" " ; echo "${formatted_names[*]}")

# Print out the formatted player names with occurrence counts
echo "$search_strings"
