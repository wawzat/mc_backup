#!/bin/bash

# Change the directory to the log folder
cd /home/mcserver/minecraft/logs

# Initialize an associative array to store player names and their occurrence counts
declare -A player_counts
declare -A player_timestamps

# Loop through each .gz file in the directory
for file in *.gz; do
    # Use zgrep to search for player names and count their occurrences
    # The regular expression ' joined the game' will match lines with player names followed by ' joined the game'
    # The -o option for grep only prints the matching part of the line.
    # The -h option for zgrep suppresses filenames in the output.
    # The -E option for zgrep enables extended regular expressions.
    # The -z option for zgrep treats the input as null-separated instead of newline-separated.
    # The -a option for zgrep treats the input as text instead of compressed data.
    names_found=$(zgrep -oE '\[[0-9]{2}:[0-9]{2}:[0-9]{2}\] \[[[:alnum:]_]+\] joined the game' -a -h "$file" | awk '{print $3}')
    # Extract the timestamp from the log file name
    timestamp=$(echo "$file" | sed -E 's/.*([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/')

    # Combine the timestamp with the date of the log file to create a full timestamp
    full_timestamp="${timestamp}T${names_found:1:8}Z"

    # Store the occurrence count and full timestamp for each player name
    for name in $names_found; do
        player_counts["$name"]=$(( player_counts["$name"] + 1 ))
        player_timestamps["$name"]="$full_timestamp"
    done
done

# Format the player names, counts, and timestamps into a table
formatted_names=()
for name in "${!player_counts[@]}"; do
    count="${player_counts[$name]}"
    timestamp="${player_timestamps[$name]}"
    formatted_names+=("$name|$count|$timestamp")
done

# Print the table header
echo "Player Name     | Count | Most Recent Join Date"

# Print the formatted player names, counts, and timestamps in a table
for name in "${formatted_names[@]}"; do
    echo "$name"
done