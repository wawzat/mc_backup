#!/bin/bash
# This script is intended to be run by cron for daily backups of Minecraft data.
# Sample cron entry 0 10 * * * /home/mcserver/minecraft/mc_backup/backup_mc_daily runs the script at 10:00 AM every day.

# Configuration variables, change according to your particulars
num_days=5  # Number of days to keep backups for
backup_path="/home/mcserver/minecraft/backup"
log_search_path="/home/mcserver/minecraft/logs"
world_paths=(
  "/home/mcserver/minecraft/world"
  "/home/mcserver/minecraft/world_nether"
  "/home/mcserver/minecraft/world_the_end"
  # Add more paths here if needed
)

# Change the directory to the log folder
cd "$log_search_path"

# Set the minimum number of plays required to include a player name
minimum_plays=30

# Initialize an associative array to store player names and their occurrence count
declare -A player_counts

# Loop through each .gz file in the directory
for file in *.gz; do
    # Use zgrep to search for player names and extract them
    # The regular expression ' joined the game' will match lines with player names followed by ' joined the game'
    # The -o option for grep only prints the matching part of the line.
    # The -h option for zgrep suppresses filenames in the output.
    names_found=$(zgrep -oE '[[:alnum:]_]+ joined the game' "$file" | awk '{print $1}')
    
    # Increment the occurrence count of each player name in the associative array
    for name in $names_found; do
        ((player_counts["$name"]++))
    done
done

# Initialize an empty array to store player names that meet the minimum play requirement
search_strings=()

# Loop through the associative array and filter player names based on the minimum play count
for name in "${!player_counts[@]}"; do
    count="${player_counts[$name]}"
    if ((count >= minimum_plays)); then
        search_strings+=("$name")
    fi
done

# Print out the formatted player names
#echo "${search_strings}"

# Initialize variables to store the most recent file and date
most_recent_file=""
most_recent_date="0000-00-00"  # Initialize with a date in the past

# Function to get the modification date of a file in "YYYY-MM-DD" format
get_file_date() {
    local file="$1"
    # Get the date of the file and format it as "YYYY-MM-DD"
    date -r "$file" +"%Y-%m-%d"
}

# Loop through each search string
for search_string in "${search_strings[@]}"; do
    # Use find to search for .log files and .gz files containing the current search string
    # and compare their dates to find the most recent file
    while IFS= read -r file; do
        if [[ "$file" == *.gz ]]; then
            # For .gz files, use zgrep
            if zgrep -q "$search_string" "$file"; then
                # Get the date of the file
                file_date=$(get_file_date "$file")
                # Compare the date of the current file with the most_recent_date
                if [[ "$file_date" > "$most_recent_date" ]]; then
                    most_recent_file="$file"
                    most_recent_date="$file_date"
                fi
            fi
        else
            # For uncompressed .log files, use grep
            if grep -q "$search_string" "$file"; then
                # Get the date of the file
                file_date=$(get_file_date "$file")
                # Compare the date of the current file with the most_recent_date
                if [[ "$file_date" > "$most_recent_date" ]]; then
                    most_recent_file="$file"
                    most_recent_date="$file_date"
                fi
            fi
        fi
    done < <(find "$log_search_path" -type f \( -name "*.log*" -o -name "*.gz" \))
done

# Output the date (YYYY-MM-DD) of the most recent file containing any of the search strings
if [[ "$most_recent_date" != "0000-00-00" ]]; then
    # Check if any files in /home/mcserver/minecraft/backup are newer than the most recent date
    if [[ $(find "$backup_path" -type f -newermt "$most_recent_date" 2>/dev/null) ]]; then
        result="True: Some files in $backup_path were created after $most_recent_date."
    else
        result="False: No files in $backup_path were created after $most_recent_date."
    fi
else
    result="None of the search strings found in any of the .log files."
fi

if [[ $result == *"False"* ]]; then
    screen -R mc -xX stuff "say Server backup starting. World not saving until complete...$(printf '\r')"
    screen -R mc -xX stuff "save-off$(printf '\r')"
    screen -R mc -xX stuff "save-all$(printf '\r')"
    sleep 3

    # Move the existing backup files
    for ((i=num_days-1; i>0; i--)); do
        current_day=$((i - 1))
        if [ -f "${backup_path}/minecraft_day${current_day}.tar.gz" ]; then
            mv "${backup_path}/minecraft_day${current_day}.tar.gz" "${backup_path}/minecraft_day${i}.tar.gz"
        fi
    done

    tar -cpvzf "${backup_path}/minecraft_day0.tar.gz" "${world_paths[@]}"

        screen -R mc -xX stuff "save-on$(printf '\r')"
        screen -R mc -xX stuff "say Server backup complete. World now saving. $(printf '\r')"
else
    echo "World not modified since most recent backup, no backup required. $(printf '\r')"
fi