#!/bin/bash

# Change the directory to the log folder
cd /home/mcserver/minecraft/logs

# Initialize an associative array to store player names and their occurrence counts
declare -A player_counts
declare -A player_last_left_times
declare -A player_last_left_epoch_times

# Compress the latest.log file
gzip -c latest.log > latest.log.gz

# Loop through each .gz file in the directory
for file in *.gz; do
    # Use zcat to search for player names and count their occurrences
    # The regular expression ' left the game' will match lines with player names followed by ' left the game'
    # The date is parsed from the log filename, the time is parsed from the log line
    # Extract the date from the filename
    file_date=$(echo "$file" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}')
    while read -r line; do
        if [[ $line =~ \[([0-9]{2}:[0-9]{2}:[0-9]{2})\] ]]; then
            time=${BASH_REMATCH[1]}
        elif [[ $line =~ \[([0-9]{2}[A-Za-z]{3}[0-9]{4} [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3})\] ]]; then
            time=${BASH_REMATCH[1]:10:8}
        fi
        name=$(echo "$line" | grep -oE '[[:alnum:]_]+ left the game' | awk '{print $1}')
        if [[ -n "$name" ]]; then
            player_counts["$name"]=$(( player_counts["$name"] + 1 ))
            player_last_left_times["$name"]=$(date -d "$file_date $time" "+%Y-%m-%d %H:%M:%S")
            player_last_left_epoch_times["$name"]=$(date -d "$file_date $time" "+%s")
        fi
    done < <(zcat "$file" | grep -E '[[:alnum:]_]+ left the game')
done

# Delete the compressed copy of latest.log
rm latest.log.gz

# Find the latest player_last_left_epoch_time for player names w